language: cpp
os: 
    - linux
    - osx
compiler:
    - gcc
    - clang
matrix:
    exclude:
        - os: osx
          compiler: gcc

osx_image: xcode611

before_install:
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo add-apt-repository "deb http://us.archive.ubuntu.com/ubuntu/ trusty main universe multiverse"; fi
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get update; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew update; fi

    # fixing broken OSX gzip tools
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then export PATH=/usr/local/bin:$PATH; fi # so that brew-installed ones are first
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew tap homebrew/dupes; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew install gzip; fi

install:
    - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'clang++' ]]; then sudo apt-get install --no-install-recommends clang-3.5; fi
    - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'g++'     ]]; then sudo apt-get install --no-install-recommends g++; fi
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get install --no-install-recommends libhdf5-7; fi
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get install --no-install-recommends libpango-1.0-0 libpangocairo-1.0-0 libhdf5-dev; fi
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get install --no-install-recommends -t trusty -y libboost-thread-dev libboost-timer-dev libblitz0-dev gnuplot-nox libhdf5-serial-dev cmake libgnuplot-iostream-dev hdf5-tools python-matplotlib; fi
    #- if [[ $TRAVIS_OS_NAME == 'osx' && $CXX == 'g++' ]]; then brew install gcc48; fi   # would need a gcc-compiled boost ...
    #- if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew reinstall boost --c++11; fi          # ...what takes too long :(
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then sudo brew tap homebrew/science; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew install gnuplot blitz; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew install hdf5 --with-cxx; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then wget -O /usr/local/include/gnuplot-iostream.h http://gitorious.org/gnuplot-iostream/gnuplot-iostream/raw/gnuplot-iostream.h; fi

script:
    # libmpdata++
    - mkdir build 
    - cd build
    - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'clang++' ]]; then cmake -DCMAKE_CXX_COMPILER=/usr/bin/clang++ ../; fi # Travis default is not the packaged one
    - if [[ $TRAVIS_OS_NAME == 'osx' && $CXX == 'g++' ]]; then cmake -DCMAKE_CXX_COMPILER=g++-4.8 ../; fi # the one from homebrew
    - cmake -DCMAKE_BUILD_TYPE=Debug ../

    # compiling and running all unit tests in Debug mode
    - VERBOSE=1 make -C tests/unit
    - OMP_NUM_THREADS=4 make -C tests/unit test || cat tests/unit/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)

    # compiling and running selected tutorial tests in Debug mode
    - VERBOSE=1 make -C tests/tutorial/6_coupled_harmosc
    - OMP_NUM_THREADS=4 make -C tests/tutorial/6_coupled_harmosc test || cat tests/tutorial/6_coupled_harmosc/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)

    # compiling everything in the Release mode
    - cmake -DCMAKE_BUILD_TYPE=Release ../
    - VERBOSE=1 make

    # running selected tests in Release mode for 1 and 4 threads
    - OMP_NUM_THREADS=1 make -C tests/unit test || cat tests/unit/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/unit test || cat tests/unit/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=1 make -C tests/tutorial/0_basic_example test || cat tests/tutorial/0_basic_example/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=1 make -C tests/tutorial/1_advscheme_opts test || cat tests/tutorial/1_advscheme_opts/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/2_convergence_1d test || cat tests/tutorial/2_convergence_1d/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/3_rotating_cone_2d test || cat tests/tutorial/3_rotating_cone_2d/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/4_revolving_sphere_3d test || cat tests/tutorial/4_revolving_sphere_3d/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/5_over_the_pole_2d test || cat tests/tutorial/5_over_the_pole_2d/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/6_coupled_harmosc test || cat tests/tutorial/6_coupled_harmosc/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/7_shallow_water test || cat tests/tutorial/7_shallow_water/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)
    - OMP_NUM_THREADS=4 make -C tests/tutorial/8_boussinesq_2d test || cat tests/tutorial/8_boussinesq_2d/Testing/Temporary/LastTest.log / # "/" intentional! (just to make cat exit with an error code)

    # installing
    - sudo make install
    - cd ../..
    
    # libcloudph++'s dependencies
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get install --no-install-recommends -t trusty -y libboost-python-dev python-numpy libthrust-dev; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then brew install boost-python; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then git clone --depth=1 git://github.com/thrust/thrust.git; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then sudo ln -s `pwd`/thrust/thrust /usr/local/include/thrust; fi

    # libcloudph++ (needed by icicle, skipping tests and CUDA build)
    - git clone --depth=1 git://github.com/igfuw/libcloudphxx.git
    - cd libcloudphxx
    - mkdir build 
    - cd build
    - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'clang++' ]]; then cmake -DCMAKE_CXX_COMPILER=/usr/bin/clang++ ../; fi # Travis default is not the packaged     one
    - if [[ $TRAVIS_OS_NAME == 'osx' && $CXX == 'g++' ]]; then cmake -DCMAKE_CXX_COMPILER=g++-4.8 ../; fi # the one from homebrew
    - cmake -DCMAKE_BUILD_TYPE=Release ../ 
    - make 
    - sudo make install
    - cd ../..

    ## icicle (no tests - just testing if any changes in libmpdata's API did not break icicle)
    - if [[ $TRAVIS_OS_NAME == 'linux' ]]; then sudo apt-get install --no-install-recommends -t trusty -y libboost-program-options-dev; fi
    - git clone --depth=1 git://github.com/igfuw/icicle.git
    - cd icicle
    - mkdir build 
    - cd build
    - if [[ $TRAVIS_OS_NAME == 'linux' && $CXX == 'clang++' ]]; then cmake -DCMAKE_CXX_COMPILER=/usr/bin/clang++ ../; fi # Travis default is not the packaged     one
    - if [[ $TRAVIS_OS_NAME == 'osx' && $CXX == 'g++' ]]; then cmake -DCMAKE_CXX_COMPILER=g++-4.8 ../; fi # the one from homebrew
    - cmake -DCMAKE_BUILD_TYPE=Release ../ 
    - make
